---
title: "airflow를 이용한 배치 데이터 처리-(2)"
excerpt: "Airflow 주요 개념"
categories:
  - data
tags:
  - airflow
  - workflow
  - dataEngineering
last_modified_at: 2020-06-10T08:06:00-05:00
---

> 워크플로우 관리 도구 중 하나인 airflow를 이용하여 배치 데이터를 처리해봅니다. 
>
> [1번째 포스팅](/data/airflow_1)에서는 워크플로우 관리에 대한 개념을 정리합니다.
>
> 이번 포스팅에서는 airflow의 개념과 제공하는 기능에 대해 정리합니다. [공식 문서](https://airflow.apache.org/docs/stable/concepts.html)를 대부분 참고했습니다.
>
> [3번째 포스팅](/data/airflow_3)에서는 코드 수준에서 airflow를 단계적으로 실행해봅니다.

Airflow는 파이썬으로 만들어졌고 pip로 설치 가능하며, 파이썬 스크립트를 통해 워크플로우를 정의해야 합니다.

# Core Ideas

## DAGs

airflow에서는 워크플로우를 DAG(Directed Acyclic Graph)로 관리합니다. 각 태스크들의 관계와 종속성을 DAG로 표현하게 됩니다.

airflow는 `DAG_FOLDER`로 설정된 서브디렉토리 내의 파이썬 파일을 읽어들여서 DAG객체를 동적으로 생성합니다.

### Scope

파이썬 파일 내에 DAG는 전역 스코프에 존재해야 합니다. 다음과 같이 작성하면, `dag_1`만 airflow에 로드됩니다.

```python
dag_1 = DAG('this_dag_will_be_discovered')

def my_function():
  dag_2 = DAG('this_dag_will_not')
  
my_function()
```

때때로 이를 이용해서 subDAG를 함수 내에 정의하여 standalone DAG로 로드되지 않도록 할 수 있습니다.

### Default Arguments

`default_arg`라는 딕셔너리를 DAG에 파라미터로 넘기면 모든 operator들에 적용됩니다. 

```python
default_args = {
  'start_date' : datetime(2016, 1, 1),
  'owner' : 'airflow'
}

dag = DAG('my_dag', default_args=default_args)
op = DummyOperator(task_id='dummy', dag=dag)
print(op.owner) # Airflow
```

### Context Manager

airflow 버전 1.8부터 DAG를 컨텍스트 매니저로 사용해서, DAG에 operator를 자동으로 할당할 수 있습니다.

```python
with DAG('my_dag', start_date=datetime(2016, 1, 1)) as dag:
  op = DummyOperator('op')
op.dag is dag # True
```

## DAG Runs

DAG run이란 task instance를 특정 `execution date`에 실행하는 DAG의 인스턴스입니다.

DAG run은 보통 airflow scheduler에 의해 생성되고, 외부 트리거에 의해 생성될 수도 있습니다. `excution_date`가 다른 다수의 DAG run 이 한 순간에 실행될 수도 있습니다.

### excution_date

`excution_date`는 DAG run과 task instance가 실행되는 **논리적인 시간**입니다.(실제 현재 시간과는 다릅니다)

DAG run과 task instance는 동일한 `execution_date` 로 인스턴스화됩니다. 따라서 **과거의 날짜 및 시간**에 맞춰서 태스크를 실행할 수 있습니다.

## Airflow 용어 정리

| when?       | DAG     | Task          | Info about other tasks                                       |
| ----------- | ------- | ------------- | ------------------------------------------------------------ |
| 정의        | DAG     | Task          | [get_flat_relatives](https://airflow.apache.org/_modules/airflow/models.html#BaseOperator.get_flat_relatives) |
| 실행        | DAG run | Task Instance | [xcom_pull](https://airflow.incubator.apache.org/concepts.html#xcoms) |
| 기본 클래스 | DAG     | BaseOperator  |                                                              |



# Reference

https://airflow.apache.org/docs/stable/concepts.html

https://aldente0630.github.io/data-engineering/2018/06/17/developing-workflows-with-apache-airflow.html